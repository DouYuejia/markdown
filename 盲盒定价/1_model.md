# 盲盒建模

## 盲盒参数

一个盲盒中存在两类商品：$n$类普通商品（具有价值$v_r$）和1类特殊商品（具有价值$v_s$），我们假设$v_s >v_r$。

代理商需要决定的盲盒参数：价格$c$，特殊商品抽中概率$p$（相应的，每一类普通商品抽中概率为$\frac{1-p}{n}$）。

## 消费者行为

### MDP建模

消费者行为使用MDP建模$(S,A,P,R)$：

- $S$:使用二元组$\{N_r,N_s\}$表示，其中$N_r,N_s$分别表示当前状态下获得的普通商品和特殊商品的种类数（$N_r \in \{0,1,...,n\},N_s \in\{0,1\}$）。
- $A$:动作空间中只有两种动作$\{a_p,a_q\}$，分别代表花费$c$购买一个盲盒和不购买盲盒即退出。
- $P$:
  - 获得一个新类型的普通商品：$P_{a_p}(\{N_r,0\},\{N_r+1,0\})=(1-p)\cdot\frac{n-n_r}{n} $
  - 获得一个已有类型的普通商品：$P_{a_p}(\{N_r,0\},\{N_r,0\})=(1-p)\cdot\frac{n_r}{n} $
  - 第一次获得特殊商品：$P_{a_p}(\{N_r,0\},\{N_r,1\})=p $
  - 在已获得过特殊商品情况下获得特殊商品：$P_{a_p}(\{N_r,1\},\{N_r,1\})=p $
  - 在已获得过特殊商品情况下获得新类型普通商品：$P_{a_p}(\{N_r,1\},\{N_r+1,1\})=(1-p)\cdot\frac{n-n_r}{n} $
- $R$:
  - 获得一个新类型普通商品:$v_r$
  - 第一次获得特殊商品:$v_s$
  - 获得已经获得过的商品类型:0

MDP决策过程示意图：

![image-20250312172257586](C:\Users\dyj02\AppData\Roaming\Typora\typora-user-images\image-20250312172257586.png)

### 消费者在每个状态的未来奖励估值

- 已获得特殊商品：

  - $V(n,1)=0$
  - $V(i,1)=(n-i)\cdot v_r-\frac{c\cdot n}{1-p}\sum_{j=1}^{n-i}{\frac{1}{j}}$

- 未获得特殊商品：

  - $V(n,0)=(1-p)\cdot V(n,0)+p\cdot v_s+p\cdot V(n,1)-c$

  - $V(n,0)=v_s-\frac{c}{p}$

  - $V(n-1,0)=(1-p)\cdot \frac{n-1}{n}\cdot V(n-1,0)+(1-p)\cdot \frac{1}{n}\cdot v_r+(1-p)\cdot \frac{1}{n}\cdot V(n,0)+p\cdot v_s+p\cdot V(n-1,1)-c$

  - 定义以下辅助变量：

    - $A(i)=(1-p)\cdot \frac{n-i}{n}\cdot v_r$
    - $B=p\cdot v_s$
    - $C(i)=1-(1-p)\cdot \frac{i}{n}$
    - $D(i)=p\cdot V(i,1)=p\cdot ((n-i)\cdot v_r-\frac{c\cdot n}{1-p}\sum_{j=1}^{n-i}{\frac{1}{j}})$
    - $F(i)=\frac{A(i)+B+D(i)-c}{C(i)}$

  - 从$V(n,0)$向前递推可知：

    $V(n-i,0)=F(n-i)+\frac{(1-p)\cdot \frac{i}{n}}{C(n-i)}\cdot F(n-i+1)+\frac{(1-p)^2\cdot \frac{i\cdot(i-1)}{n^2}}{C(n-i)\cdot C(n-i+1)}\cdot F(n-i+2)+\cdots +\frac{(1-p)^i\cdot \frac{i!}{n^i}}{C(n-i)\cdots C(n-1)}\cdot F(n)$

    归纳可得

    ​		$V(n-i,0) =F(n-i)+\sum_{k=1}^i\left(\prod_{j=0}^{k-1}\frac{(1-p)\frac{i-j}{n}}{C(n-i+j)}\right)\cdot F(n-i+k)\\ = \sum_{k=0}^i\left[\prod_{j=0}^{k-1}\frac{(1-p)\frac{i-j}{n}}{C(n-i+j)}\right]\cdot F(n-i+k)$

  - 即

    ​			$V(i,0)=F(i)+\sum_{k=1}^{n-i}\left(\prod_{j=0}^{k-1}\frac{(1-p)\cdot \frac{n-i-j}{n}}{C(i+j)}\right)\cdot F(i+k)\\= \sum_{k=0}^{n-i}\left[\prod_{j=0}^{k-1}\frac{(1-p)\frac{n-i-j}{n}}{C(i+j)}\right]\cdot F(i+k)$

- 性质：

  - $V(nr,0)$具有相同符号且递减；$V(nr,1)$递减但可能由正变负。这意味着消费者在初始状态要么一个盲盒不买，要么一直买直到MDP值为负（一般情况下抽到特殊商品MDP值就变负，但是c足够小可能存在继续买几个的情况）。

## 供应商-消费者交互

### 在给定盲盒参数下消费者预期购买数量

- **行为1**：一旦获得特殊商品就停止购买($V(0,0)>0,V(0,1)\leq0$)

  $E(0,0)=E(1,0)=\cdots = E(n,0)=\frac{1}{p}$

- **行为2：**获得特殊商品之后继续购买，直到收益估值变为非正($V(0,0)>0,V(0,1)>0$)

  - 终止购买条件：$\begin{cases}V(n^*-1,1)&>0\\V(n^*,1)&\leq0&\end{cases}$，其中$n*\leq n$

  令$n_r$表示当消费者获得特殊商品时已获得的普通商品类别数，即消费者的状态变化为：$\{0,0\}\rightarrow\{n_r,0\}\rightarrow\{n_r,1\}\rightarrow\{n^*,1\}$。MDP决策过程如下：![image-20250314133514943](C:\Users\dyj02\AppData\Roaming\Typora\typora-user-images\image-20250314133514943.png)

  分析过程：

- 已获得特殊商品：

  - $E(n^*,1)=E(n^*+1,1)=\cdots E(n,1)=0$
  - $E(i,1)=\frac{n}{1-p}\cdot \sum_{j=1}^{i} \frac{1}{n-(n^*-j)}$,其中$i\leq n^*$（注意到当取等时为“空求和”，值为0）

- 未获得特殊商品：

  - $E(n^*,0)=E(n^*+1,0)=\cdots E(n,0)=\frac{1}{p}$

  - $E(n^*-1,0)=(1-p)\frac{n^*-1}{n}\cdot E(n^*-1,0)+p\cdot E(n^*-1,1)+(1-p)\frac{n-n^*+1}{n}\cdot E(n^*,0)+1$

  - 定义以下辅助变量：

    - $A(i)=\frac{n-i}{n}(1-p)$
    - $C(i)=1-(1-p)\frac{i}{n}$
    - $D(i)=p\cdot E(i,1)=p\cdot \frac{n}{1-p}\cdot \sum_{j=1}^{i}\frac{1}{n-(n^*-j)}$
    - $F(i)=\frac{D(i)+1}{C(i)}$，其中$F(n^*)=\frac{1}{p}$

  - 从$E(n^*,0)$向前递推可知：

    $E(n^*-i,0)=\sum_{r=0}^i\left(\prod_{\ell=0}^{r-1}\frac{A(n^*-i+\ell)}{C(n^*-i+\ell)}\right)\cdot F\left(n^*-(i-r)\right)$

  - 即

    $E(i,0)=\sum_{r=0}^{n^*-i}\left(\prod_{\ell=0}^{r-1}\frac{A(i+\ell)}{C(i+\ell)}\right)\cdot F\left(i+r)\right)$



### 在给定盲盒参数下供应商预期收益

供应商的总收益为消费者预期购买数量与盲盒定价的乘积，即$REV=E(0,0)\cdot c=c\cdot \sum_{r=0}^{n}\left(\prod_{\ell=0}^{r-1}\frac{A(\ell)}{C(\ell)}\right)\cdot F\left(r)\right)$

预期存在两组参数都可以得到类似的最优收益：1）高p高c；2）低p低c

#### 使用网格查找最优参数

对于每种消费者购买行为（行为1：抽中特殊就不买；行为2：抽中特殊多买几个）寻找对应的最佳参数$(p,c)$

| 变量  | 取值范围              |
| :---: | --------------------- |
|  $N$  | 100                   |
| $v_s$ | 100                   |
| $v_r$ | 1                     |
|  $p$  | 查找范围$[0.001,0.1]$ |
|  $c$  | 查找范围[0.1,2]       |



![image-20250321103930295](C:\Users\dyj02\AppData\Roaming\Typora\typora-user-images\image-20250321103930295.png)

搜索最优的N，Q，C：

期望结论：存在最优的N值，而不是越大越好；

![image-20250324165326136](C:\Users\dyj02\AppData\Roaming\Typora\typora-user-images\image-20250324165326136.png)

![image-20250324165338212](C:\Users\dyj02\AppData\Roaming\Typora\typora-user-images\image-20250324165338212.png)

Behavior 2 (continue buying) - Top 50 Parameters:
Group 1: Q=0.00019999999999999998, C=0.12448979591836735, N=1000, REV=622.5338256317291, E=5000.6815501565125
Group 2: Q=0.00019999999999999998, C=0.1163265306122449, N=1000, REV=581.9296707403702, E=5002.553309873358
Group 3: Q=0.00019999999999999998, C=0.10816326530612246, N=1000, REV=541.4555394407405, E=5005.909704263449
Group 4: Q=0.00019999999999999998, C=0.1, N=1000, REV=501.1035327857719, E=5011.035327857719
Group 5: Q=0.00019999999999999998, C=0.1, N=500, REV=500.5201107359316, E=5005.201107359316
Group 6: Q=0.0003, C=0.1326530612244898, N=1000, REV=442.1783129170401, E=3333.3442050669173
Group 7: Q=0.0003, C=0.12448979591836735, N=500, REV=415.1497229431736, E=3334.809249871394
Group 8: Q=0.0003, C=0.12448979591836735, N=1000, REV=415.08963225526065, E=3334.3265541816018
Group 9: Q=0.0003, C=0.1163265306122449, N=1000, REV=388.1983294592573, E=3337.1435339480013
Group 10: Q=0.0003, C=0.1163265306122449, N=500, REV=388.08750337128106, E=3336.190818454872
Group 11: Q=0.0003, C=0.10816326530612246, N=1000, REV=361.4954507348178, E=3342.127752076617
Group 12: Q=0.0003, C=0.10816326530612246, N=500, REV=361.0781079267158, E=3338.2692996998253
Group 13: Q=0.00039999999999999996, C=0.14081632653061227, N=500, REV=352.0615609512696, E=2500.1473169003198
Group 14: Q=0.0003, C=0.1, N=1000, REV=334.97068549724804, E=3349.70685497248
Group 15: Q=0.0003, C=0.1, N=500, REV=334.10770812429104, E=3341.07708124291
Group 16: Q=0.00039999999999999996, C=0.1326530612244898, N=500, REV=331.73422530008474, E=2500.7656984160235
Group 17: Q=0.00039999999999999996, C=0.1326530612244898, N=1000, REV=331.634575694429, E=2500.0144936964643
Group 18: Q=0.00039999999999999996, C=0.12448979591836735, N=500, REV=311.4686991257077, E=2501.961681501586
Group 19: Q=0.00039999999999999996, C=0.12448979591836735, N=1000, REV=311.38892895948004, E=2501.3209047564787
Group 20: Q=0.00039999999999999996, C=0.1163265306122449, N=1000, REV=291.4042548727336, E=2505.05412083578
Group 21: Q=0.00039999999999999996, C=0.1163265306122449, N=500, REV=291.25755903816685, E=2503.7930513807323
Group 22: Q=0.0005, C=0.14081632653061227, N=500, REV=281.6585642459718, E=2000.1840069641469
Group 23: Q=0.00039999999999999996, C=0.10816326530612246, N=1000, REV=271.6664796575295, E=2511.633491173386
Group 24: Q=0.00039999999999999996, C=0.10816326530612246, N=500, REV=271.1158308617673, E=2506.542587212565
Group 25: Q=0.0005, C=0.1326530612244898, N=500, REV=265.43284486197274, E=2000.95529203641
Group 26: Q=0.0005, C=0.1326530612244898, N=1000, REV=265.30852541752864, E=2000.018114685985
Group 27: Q=0.00039999999999999996, C=0.1, N=1000, REV=252.15959797063098, E=2521.5959797063097
Group 28: Q=0.00039999999999999996, C=0.1, N=500, REV=251.01104290711788, E=2510.1104290711787
Group 29: Q=0.0005, C=0.12448979591836735, N=500, REV=249.28389221267943, E=2002.4443800690642
Group 30: Q=0.0005, C=0.12448979591836735, N=1000, REV=249.18461536813467, E=2001.6469103341965
Group 31: Q=0.0006000000000000001, C=0.14081632653061227, N=500, REV=234.7249474855093, E=1666.887308230428
Group 32: Q=0.0005, C=0.1163265306122449, N=1000, REV=233.38419933477488, E=2006.2852223515733
Group 33: Q=0.0005, C=0.1163265306122449, N=500, REV=233.2021568565772, E=2004.720295784611
Group 34: Q=0.0006000000000000001, C=0.1326530612244898, N=500, REV=221.24021166164496, E=1667.8108263724005
Group 35: Q=0.0006000000000000001, C=0.1326530612244898, N=1000, REV=221.09131854898706, E=1666.688401369287
Group 36: Q=0.0005, C=0.10816326530612246, N=1000, REV=217.88708196432196, E=2014.4277389154295
Group 37: Q=0.0005, C=0.10816326530612246, N=500, REV=217.20592911247613, E=2008.1302880210055
Group 38: Q=0.0006000000000000001, C=0.12448979591836735, N=500, REV=207.84700563216197, E=1669.5907009796615
Group 39: Q=0.0006000000000000001, C=0.12448979591836735, N=1000, REV=207.72839338429068, E=1668.6379140705317
Group 40: Q=0.0005, C=0.1, N=1000, REV=202.67055396407463, E=2026.705539640746
Group 41: Q=0.0005, C=0.1, N=500, REV=201.25455757366535, E=2012.5455757366533
Group 42: Q=0.0007, C=0.14081632653061227, N=500, REV=201.20240164604039, E=1428.8286493704315
Group 43: Q=0.0006000000000000001, C=0.1163265306122449, N=1000, REV=194.7504251842062, E=1674.1703217589654
Group 44: Q=0.0006000000000000001, C=0.1163265306122449, N=500, REV=194.533551512957, E=1672.3059691464723
Group 45: Q=0.0007, C=0.1326530612244898, N=500, REV=189.68110746406603, E=1429.9037331906516
Group 46: Q=0.0007, C=0.1326530612244898, N=1000, REV=189.50773642997572, E=1428.5967823182784
Group 47: Q=0.0006000000000000001, C=0.10816326530612246, N=1000, REV=182.13013349595363, E=1683.844630434288
Group 48: Q=0.0006000000000000001, C=0.10816326530612246, N=500, REV=181.32121914473512, E=1676.3659883192493
Group 49: Q=0.0006000000000000001, C=0.10816326530612246, N=100, REV=180.44539260075035, E=1668.268724044673
Group 50: Q=0.0007, C=0.12448979591836735, N=500, REV=178.26591383118298, E=1431.9720947095025

Behavior 1 (once special then left) - Top 50 Parameters:
Group 1: Q=0.00039999999999999996, C=0.14081632653061227, N=1000, REV=352.04081632653066, E=2500.0
Group 2: Q=0.0005, C=0.15714285714285714, N=500, REV=314.2857142857143, E=2000.0
Group 3: Q=0.0005, C=0.1489795918367347, N=500, REV=297.9591836734694, E=2000.0
Group 4: Q=0.0005, C=0.14081632653061227, N=1000, REV=281.6326530612245, E=2000.0
Group 5: Q=0.0006000000000000001, C=0.15714285714285714, N=500, REV=261.90476190476187, E=1666.6666666666665
Group 6: Q=0.0006000000000000001, C=0.1489795918367347, N=500, REV=248.29931972789115, E=1666.6666666666665
Group 7: Q=0.0007, C=0.1653061224489796, N=500, REV=236.1516034985423, E=1428.5714285714287
Group 8: Q=0.0006000000000000001, C=0.14081632653061227, N=1000, REV=234.69387755102042, E=1666.6666666666665
Group 9: Q=0.0007, C=0.15714285714285714, N=500, REV=224.48979591836735, E=1428.5714285714287
Group 10: Q=0.0007, C=0.1489795918367347, N=500, REV=212.82798833819245, E=1428.5714285714287
Group 11: Q=0.0007999999999999999, C=0.1653061224489796, N=500, REV=206.63265306122452, E=1250.0
Group 12: Q=0.0007, C=0.14081632653061227, N=1000, REV=201.16618075801753, E=1428.5714285714287
Group 13: Q=0.0007999999999999999, C=0.15714285714285714, N=500, REV=196.42857142857142, E=1250.0
Group 14: Q=0.0007999999999999999, C=0.1489795918367347, N=500, REV=186.22448979591837, E=1250.0
Group 15: Q=0.0009, C=0.1653061224489796, N=500, REV=183.67346938775512, E=1111.111111111111
Group 16: Q=0.0007999999999999999, C=0.14081632653061227, N=1000, REV=176.02040816326533, E=1250.0
Group 17: Q=0.0009, C=0.15714285714285714, N=500, REV=174.6031746031746, E=1111.111111111111
Group 18: Q=0.001, C=0.17346938775510207, N=500, REV=173.46938775510208, E=1000.0
Group 19: Q=0.0009, C=0.1489795918367347, N=500, REV=165.53287981859413, E=1111.111111111111
Group 20: Q=0.001, C=0.1653061224489796, N=500, REV=165.3061224489796, E=1000.0
Group 21: Q=0.0012, C=0.1979591836734694, N=100, REV=164.96598639455783, E=833.3333333333334
Group 22: Q=0.0013, C=0.2142857142857143, N=100, REV=164.83516483516485, E=769.2307692307693
Group 23: Q=0.0014999999999999998, C=0.23877551020408164, N=100, REV=159.18367346938777, E=666.6666666666667
Group 24: Q=0.0014, C=0.22244897959183674, N=100, REV=158.8921282798834, E=714.2857142857143
Group 25: Q=0.0013, C=0.20612244897959187, N=100, REV=158.55572998430145, E=769.2307692307693
Group 26: Q=0.0011, C=0.17346938775510207, N=500, REV=157.69944341372914, E=909.090909090909
Group 27: Q=0.001, C=0.15714285714285714, N=500, REV=157.14285714285714, E=1000.0
Group 28: Q=0.0009, C=0.14081632653061227, N=1000, REV=156.4625850340136, E=1111.111111111111
Group 29: Q=0.0015999999999999999, C=0.2469387755102041, N=100, REV=154.33673469387756, E=625.0
Group 30: Q=0.0014999999999999998, C=0.2306122448979592, N=100, REV=153.7414965986395, E=666.6666666666667
Group 31: Q=0.0014, C=0.2142857142857143, N=100, REV=153.06122448979593, E=714.2857142857143
Group 32: Q=0.0013, C=0.1979591836734694, N=100, REV=152.27629513343803, E=769.2307692307693
Group 33: Q=0.0011, C=0.1653061224489796, N=500, REV=150.278293135436, E=909.090909090909
Group 34: Q=0.0017, C=0.2551020408163266, N=100, REV=150.0600240096039, E=588.2352941176471
Group 35: Q=0.0015999999999999999, C=0.23877551020408164, N=100, REV=149.23469387755102, E=625.0
Group 36: Q=0.001, C=0.1489795918367347, N=500, REV=148.9795918367347, E=1000.0
Group 37: Q=0.0014999999999999998, C=0.22244897959183674, N=100, REV=148.29931972789117, E=666.6666666666667
Group 38: Q=0.0014, C=0.20612244897959187, N=100, REV=147.23032069970847, E=714.2857142857143
Group 39: Q=0.0018, C=0.263265306122449, N=100, REV=146.25850340136057, E=555.5555555555555
Group 40: Q=0.0017, C=0.2469387755102041, N=100, REV=145.25810324129654, E=588.2352941176471
Group 41: Q=0.0012, C=0.17346938775510207, N=500, REV=144.55782312925172, E=833.3333333333334
Group 42: Q=0.0015999999999999999, C=0.2306122448979592, N=100, REV=144.1326530612245, E=625.0
Group 43: Q=0.0014999999999999998, C=0.2142857142857143, N=100, REV=142.8571428571429, E=666.6666666666667
Group 44: Q=0.0019, C=0.27142857142857146, N=100, REV=142.85714285714286, E=526.3157894736842
Group 45: Q=0.0011, C=0.15714285714285714, N=500, REV=142.85714285714283, E=909.090909090909
Group 46: Q=0.0018, C=0.2551020408163266, N=100, REV=141.72335600907033, E=555.5555555555555
Group 47: Q=0.0014, C=0.1979591836734694, N=100, REV=141.399416909621, E=714.2857142857143
Group 48: Q=0.001, C=0.14081632653061227, N=1000, REV=140.81632653061226, E=1000.0
Group 49: Q=0.0017, C=0.23877551020408164, N=100, REV=140.4561824729892, E=588.2352941176471
Group 50: Q=0.0019999999999999996, C=0.2795918367346939, N=100, REV=139.79591836734699, E=500.0000000000001

![image-20250324231126127](C:\Users\dyj02\AppData\Roaming\Typora\typora-user-images\image-20250324231126127.png)
